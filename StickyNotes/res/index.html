<!-- OmniView:on -->
<html>
<head>
	<script type="module">
		import * as env from "@env";
		import { Settings } from "js/settings.js";

		let dic_guid2view = {};

		function NewNote(color, size) {
			let guid = Window.this.xcall("Host_NewGUID");
			Settings.root.dic_notes[guid] = { size: size, color: color };
			Settings.commit();
			return guid;
		}

		Window.this.Proxy_AddNote = function() {// from taskbar
			let size = {};
			let color = 0;
			if(Settings.root.dic_notes.length > 0) {
				let last_guid = Object.keys(dic_guid2view)[dic_guid2view.length - 1];
				let note = Settings.root.dic_notes[last_guid];

				let base_view = dic_guid2view[Object.keys(dic_guid2view)[0]];
				let [x, y, width, height] = base_view.box("rectw", "border", "desktop");
				size = {
					x: x + width + 6,
					y: y,
					width: width,
					height: height
				};
				color = note.color;
			}

			Window.this.Proxy_CreateStickyView(color, size);
		};

		Window.this.Proxy_CreateStickyView = function(color, size) {// from + button or taskbar, not called for notes loaded from config
			outer: while(true)
			{
				for(let guid in Settings.root.dic_notes) {
					let v = Settings.root.dic_notes[guid];
					if(v.size && JSON.stringify(v.size) == JSON.stringify(size)) {
						size.x += 20;
						size.y += 20;
						continue outer;
					}
				}
				break;
			}

			let guid = NewNote(color, size);
			let new_view = Window.this.xcall("Host_CreateStickyWindow", guid);
			dic_guid2view[guid] = new_view;
		};

		if(Settings.root.dic_notes.length == 0)
			NewNote(0, undefined);

		for(let guid in Settings.root.dic_notes) {
			let v = Settings.root.dic_notes[guid];
			let new_view = Window.this.xcall("Host_CreateStickyWindow", guid);
			dic_guid2view[guid] = new_view;
		}
	</script>
</head>
</html>